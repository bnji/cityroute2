
<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<style type="text/css">
	body {
	    padding: 0;
	    margin: 0;
	}
	html, body, #map {
		height: 100%;
	}
	.hide {
		display: none;
	}
	#menu {
		position: absolute;
		top: 10px;
		right: 10px;
		z-index: 1;
		background-color: #fff;
		padding: 5px;
		min-width: 275px;
		-webkit-border-radius: 5px;
		-moz-border-radius: 5px;
		border-radius: 5px;
		-webkit-box-shadow: -2px 2px 3px 0px rgba(50, 50, 50, 0.5);
		-moz-box-shadow:    -2px 2px 3px 0px rgba(50, 50, 50, 0.5);
		box-shadow:         -2px 2px 3px 0px rgba(50, 50, 50, 0.5);
	}
	</style>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
	<link rel="stylesheet" href="http://bootswatch.com/cosmo/bootstrap.min.css" />
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<script src="assets/js/jquery.xml2json.js"></script>
    <script type='text/javascript' src='http://rawgit.com/bnji/simplemvc/master/simple.mvc.js'></script>
	<script type='text/javascript' src='http://rawgit.com/bnji/simplemvc/master/simple.mvc.json.js'></script>
	<script src="http://rawgit.com/bnji/simplemvc/master/examples/debug.js"></script>
	<script src="assets/js/json2.js"></script>
</head>
<body>
	<div class="container">
      <h1 id="nodata" style="display:none;">Ongir bussar koyra í løtuni</h1>
    </div><!-- /.container -->

    <div id="menu">
    	<form class="form-horizontal" role="form">
  			<select id="selectBusLine" class="form-control">
			  <option value="-1">Show all</option>
			  <option value="Red">Bussleið 1</option>
			  <option value="Green">Bussleið 2</option>
			  <option value="Blue">Bussleið 3</option>
			  <option value="Orange">Bussleið 4</option>
			  <option value="Violet">Bussleið 5</option>
			</select>
			<label>
		    	<input id="showBusStops" type="checkbox" checked="checked"> Show bus stops?
		    </label>
    	</form>
    </div>

	<div id="map"</div>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script>

		var center = new L.LatLng(62.01412, -6.77753); //Tórshavn city center

		var map = L.map('map', {
			minZoom: 13,
			maxZoom: 19/*,
			maxBounds: [
				//south west
			    [61.98486353139726, -6.839590072631835],
			    //north east
			    [62.0470263884128, -6.7221736907958975]
		    ]*/
		}).setView(center, 15);

		//map.on('click', onMapClick);

		L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'examples.map-i86knfo3'
		}).addTo(map);

		function onMapClick(e) {
			console.log(e.latlng);
		}

		//var bus1 = L.marker(center).addTo(map);//.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

		var busses = MVC.List();
		var busStops = MVC.List();

		$(function() {
			$('#map').hide();

			init(function(result) {
				if(result) {
					loadBusStops();
					//$('#nodata').hide();
					$('#map').show();
					update();
				}
				else {
					$('#nodata').show();
					//$('#map').show();
				}
			});

			$('#selectBusLine').change(function() {
				var color = this.value;
				$.each(busses, function(k,v) {
					if(color === '-1') {
						v['canDrawUI'] = true;
					}
					else {
						v['canDrawUI'] = v['lineColor'] === color;
					}
				});
			});

			$('#showBusStops').click(function() {
				var isChecked = $(this).prop('checked');
				var opacity = isChecked === true ? 1 : 0;
				$.each(busStops, function(k,v) {
					//console.log(v);
					v['marker'].setOpacity(opacity);
				});
			});
		});

		function loadBusStops() {
			getStationDataAsArray(function(data) {
				$.each(data, function(k,station) {

					var busStopIcon = 'Red';
					if(!jQuery.isEmptyObject(station['info'])) {
						var busStopLineId = station['info']['bus']['lineId'];
						if(busStopLineId === undefined) {
							busStopLineId = station['info']['bus'][0]['lineId'];
						}
						console.log(busStopLineId);
						var busNoAndColor = lineIdToBusNoAndColor(busStopLineId);
						//console.log(busNoAndColor);
						/*if(busNoAndColor !== null) {
							busStopIcon = busNoAndColor[1];
						}*/
						//console.log(busStopIcon);
					}
					else {
						//console.log(station);
					}
					var popup = L.popup({
								autoPan: false,
								keepInView: false,
								//autoPanPadding: L.point(w/2, h/2),
								closeOnClick: true
							});
					popup.setContent("<b>" + station['name'] + "</b>");

		      		var marker = L.marker(getLatLng(station['lat'], station['lng']));
		      			marker
		      				.setIcon(L.icon({
								iconUrl: 'assets/icons/busStop/' + busStopIcon + '/8.png',
								iconSize: [32, 37]
							}))
		      				.addTo(map)
		      				.bindPopup(popup);

		      		busStops.Add(new BusStop(station, marker));
				});
			});
		}

		function lineIdToBusNoAndColor(lineId) {
			switch(lineId) {
				case 241:
					return [1, 'Red'];
				case 126:
					return [2, 'Green'];
				case 243:
					return [3, 'Blue'];
				case 137:
					return [4, 'Orange'];
				case 125:
					return [5, 'Violet'];
			}
			return null;
		}

		function init(callbackSuccess) {
			getBusDataAsArray(function(data) {
				var hasData = data !== undefined;
				if(hasData) {
					$.each(data, function(k,v) {
						var w = window.innerWidth;
						var h = window.innerHeight;
						var popup = L.popup({
										autoPan: true,
										keepInView: true,
										autoPanPadding: L.point(w/2, h/2),
										closeOnClick: false
									});
							popup.setContent(getMarkerPopupContent(v));

			      		var marker = L.marker(getLatLng(v['lat'], v['lng']));
			      			marker
			      				.setIcon(getMapIcon(v))
			      				.addTo(map)
			      				.bindPopup(popup);
			      		var bus = new Bus(v, marker, true);
						busses.Add(bus);
						//console.log(bus);
				   	});
				   	//console.log(busses.Size());
				}
				callbackSuccess(hasData);
			});
		}

		function update() {
			setInterval(function() {
				getBusDataAsArray(function(data) {
					var hasData = data !== undefined;
					if(hasData) {
						$.each(data, function(k,bus) {
							//console.log(busses[k]['marker']);
							// TODO: Change zero (0)
							//console.log(busses[k]['marker'].getLatLng());
							var icon = getMapIcon(bus);
							var marker = busses[k]['marker'];
							if(busses[k]['canDrawUI']) {
								// Show the bus
								marker.setOpacity(1);
								marker.setIcon(icon);
								marker.setPopupContent(getMarkerPopupContent(bus));
								marker.setLatLng(getLatLng(bus['lat'], bus['lng']));
							}
							else {
								// Hide the bus
								marker.setOpacity(0);
							}
							//console.log(bus);
					   	});
					}
				});
				//console.log(busses.Size());
			}, 1000);
		}

		function getMapIcon(bus) {
			return L.icon({
				iconUrl: getIcon(bus),
				iconSize: [27, 27]
			});
		}

		function getMarkerPopupContent(bus) {
			return "<b>" + bus['lineName'] + "</b>" +
				"<br />Speed: " + bus['speed'] + " km/h" +
				"<br />ID: " + bus['busId'] + ", Route: " + bus['route'] +
				"<br />Line no.: " + bus['lineNumber'] +
				"<br />Line color: " + bus['lineColor'];
		}

		function getLatLng(lat, lng) {
			return L.latLng(lat, lng);
		}

		function Bus(v, _marker, _canDrawUI) {
			this.speed = v['speed'];
	    	this.info = v['info'];
	    	this.route = v['route'];
	    	this.peopleCount = v['peopleCnt'];
	    	this.lineNumber = v['lineNumber'];
	    	this.lineName = v['lineName'];
	    	this.lineColor = v['lineColor'];
	    	this.lat = v['lat'];
	    	this.lng = v['lng'];
	    	this.inStation = v['inStation'];
	    	this.direction = v['direction'];
	    	this.busNo = v['busNo'];
	    	this.busId = v['busId'];
			this.marker = _marker;
			this.canDrawUI = _canDrawUI;
		}

		function BusStop(_data, _marker) {
			this.data = _data;
			this.marker = _marker;
		}

		function getIcon(bus) {
			var direction = parseFloat(bus['direction']);
			var inStation = parseFloat(bus['inStation']);
			var isDelayed = 0;
			var iconUrl = 'assets/icons/bus/';

		  	if (isDelayed === 1) {
		  		return iconUrl + "BusWarning.png";
		  	} else {
		  		iconUrl += bus['lineColor'] + '/';
	  	  		if (inStation === 1){
	  	  			return iconUrl + "Stop.png";
	  	  		}
	  	  		else if (direction > 22.5 && direction < 67.5) {
	  	  			//NE
	  	  			return iconUrl + "NE.png";
	  	  		}
	  	  		else if (direction >= 67.5 && direction <= 112.5) {
	  	  			//E
	  	  			return iconUrl + "E.png";
	  	  		}
	  	  		else if (direction > 112.5 && direction < 157.5) {
	  	  			//SE
	  	  			return iconUrl + "SE.png";
	  	  		}
	  	  		else if (direction >= 157.5 && direction <= 202.5) {
	  	  			//S
	  	  			return iconUrl + "S.png";
	  	  		}
	  	  		else if (direction > 202.5 && direction < 247.5) {
	  	  			//SV
	  	  			return iconUrl + "SV.png";
	  	  		}
	  	  		else if (direction >= 247.5 && direction <= 292.5) {
	  	  			//V
	  	  			return iconUrl + "V.png";
	  	  		}
	  	  		else if (direction > 292.5 && direction < 337.5) {
	  	  			//NV
	  	  			return iconUrl + "NV.png";
	  	  		}
	  	  		else {
	  	  			//N
	  	  			return iconUrl + "N.png";
	  	  		}
	  		}
		}

		function getBusDataAsArray(callback) {
			getBusDataAsJson(function(json) {
				callback(json['bus']);
			});
		}

		function getStationDataAsArray(callback) {
			getStationDataAsJson(function(json) {
				callback(json['station']);
			});
		}

		function getBusDataAsJson(callback) {
			getWSData('http://kt-husid-webapp.cloudapp.net/cityroute2/proxy.php', 'buses', function(xml) {
				// Parse XML to JSON
			    callback($.xml2json(xml));
			});
		}

		function getStationDataAsJson(callback) {
			//getWSData('http://localhost/dev/cityroute2/proxy.php', 'stations', function(xml) {
			//getWSData('http://kt-husid-webapp.cloudapp.net/cityroute2/proxy.php', 'stations', function(xml) {
			getWSData('assets/data/stations.xml', 'stations', function(xml) {
				// Parse XML to JSON
			    callback($.xml2json(xml));
			});
		}

		// Method used to retreive data from REST service, if CORS is not enabled, it
		// will fail...
		function getWSData(url, query, callback) {
			/*$.ajax({
			  url: url,
			  dataType: 'xml'
			}).success(function(data) {
				//var json = $.xml2json($.parseXML(data));
			    //alert(json);
			});*/
		  $.ajax({
		    type: 'GET',
		    cache: false,
		    crossDomain: true,
		    dataType: 'xml',
		    data: {'q': query},
		    url: url,
		    success: function(xml) {
		      //console.log(xml);
		      callback(xml);
		    },
		    error: function(xhr, status, errorThrown) {
		      //alert(errorThrown+'\n'+status+'\n'+xhr.statusText);
		    }
		  });
		}
    </script>

</body>
</html>