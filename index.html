
<!DOCTYPE html>
<html>
<head>
	<title>City Route 2</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<style type="text/css">
	body {
	    padding: 0;
	    margin: 0;
	}
	html, body, #map {
		height: 100%;
	}
	.hide {
		display: none;
	}
	#menu {
		position: absolute;
		top: 10px;
		right: 10px;
		z-index: 1;
		background-color: #fff;
		padding: 5px;
		min-width: 180px;
		-webkit-border-radius: 5px;
		-moz-border-radius: 5px;
		border-radius: 5px;
		-webkit-box-shadow: -2px 2px 3px 0px rgba(50, 50, 50, 0.5);
		-moz-box-shadow:    -2px 2px 3px 0px rgba(50, 50, 50, 0.5);
		box-shadow:         -2px 2px 3px 0px rgba(50, 50, 50, 0.5);
	}
	.center-block {
	  display: block;
	  margin-left: auto;
	  margin-right: auto;
	}
	@media (max-width: 600px) {
		.background-image {
			background-image: url('assets/img/background-mobile.png');
			background-size: cover;
	    	background-repeat: no-repeat;
		}
	}
	@media (min-width: 600px) {
		.background-image {
			background-image: url('assets/img/background-desktop.png');
			background-size: cover;
	    	background-repeat: no-repeat;
		}
	}
	</style>
	<script src="assets/js/jquery-1.11.0.min.js"></script>
	<script src="assets/js/jquery-migrate-1.2.1.min.js"></script>
	<link rel="stylesheet" href="http://bootswatch.com/cosmo/bootstrap.min.css" />
	<script src="assets/js/bootstrap-3.2.0.min.js"></script>
	<script src="assets/js/jquery.xml2json.js"></script>
    <script type='text/javascript' src='http://rawgit.com/bnji/simplemvc/master/simple.mvc.js'></script>
	<script type='text/javascript' src='http://rawgit.com/bnji/simplemvc/master/simple.mvc.json.js'></script>
	<script src="http://rawgit.com/bnji/simplemvc/master/examples/debug.js"></script>
	<script src="assets/js/json2.js"></script>
	<script type="text/javascript"> if (!window['console']) console = {log: function() {}}; </script>
    <script>
    //$ = {}
    </script>
    <!--//end IE fixes -->
    <script src="http://rawgit.com/bnji/simplemvc/master/lib/jstorage.min.js"></script>

</head>
<body class="background-image">
	<!--[if lt IE 10]>
	    <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
	<![endif]-->

	<div class="container" id="nodata" style="display:none;">
		<div class="center-block">
			<h1>Ongir bussar koyra í løtuni</h1>
		</div>
    </div><!-- /.container -->

    <div id="menu" style="display:none;">
    	<form class="form-inline" role="form">
			<select id="selectBusLine" class="form-control input-sm">
			  <option value="-1">Show all</option>
			  <option value="Red">Bussleið 1</option>
			  <option value="Green">Bussleið 2</option>
			  <option value="Blue">Bussleið 3</option>
			  <option value="Orange">Bussleið 4</option>
			  <option value="Violet">Bussleið 5</option>
			</select>
			<button id="findMe" type="button" class="btn btn-primary btn-sm">Find me</button>
    	</form>
    	<form class="form-horizontal" role="form">
			<label>
		    	<input id="showBusStops" type="checkbox" checked="checked"> Show bus stops?
		    </label>
    	</form>
    </div>

	<div id="map"</div>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script>

		var center = new L.LatLng(62.01412, -6.77753); //Tórshavn city center

		var map = L.map('map', {
			minZoom: 13,
			maxZoom: 19/*,
			maxBounds: [
				//south west
			    [61.98486353139726, -6.839590072631835],
			    //north east
			    [62.0470263884128, -6.7221736907958975]
		    ]*/
		}).setView(center, 15);

		//map.on('click', onMapClick);

		var homeAddressMarker;
		var router,
		    waypoints = [],
		    line;

		map.on('locationfound', function(data) {
			var lat = data['latitude'];
			var lng = data['longitude'];

			//http://wiki.openstreetmap.org/wiki/Nominatim#Reverse%5FGeocoding%5F.2F%5FAddress%5Flookup
			getWSData('http://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lng+'&format=json', '', 'json', function(json) {
				//console.log(json);
				var lat = parseFloat(json['lat']);
				var lng = parseFloat(json['lon']);
				var latLng = getLatLng(lat, lng);
				var address = json['address']; // country, country_code, house_number, postcode, road, state, town
				var popup = L.popup({
							autoPan: false,
							keepInView: false,
							closeOnClick: true
						});

					popup.setContent("<b>" + address['road'] + "</b><br />" + address['postcode'] + " " + address['town']);

				if(homeAddressMarker !== undefined) {
					map.removeLayer(homeAddressMarker);
				}

				homeAddressMarker = L.marker(latLng);
	      			homeAddressMarker
	      				.setIcon(L.icon({
							iconUrl: 'assets/icons/house/1.png',
							iconSize: [32, 37]
						}))
	      				.addTo(map)
	      				.bindPopup(popup);

	      		waypoints.push({
			    	latLng: latLng
			    });
			    waypoints.push({
			    	latLng: L.latLng(62.013030754675505, -6.78455114364624)
			    });

			    router.route(waypoints, function(err, routes) {
		            if (line) {
		                map.removeLayer(line);
		            }

		            if (err) {
		                alert(err);
		            } else {
		                line = L.Routing.line(routes[0]).addTo(map);
		            }
		        });

			});
			//console.log(e);
		});

		L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '<a href="http://bnji.github.com">Benjamin Hammer</a> | <a href="http://citypulse.torshavn.fo">Citypulse</a>',
			/*attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',*/
			id: 'examples.map-i86knfo3'
		}).addTo(map);

		function onMapClick(e) {
			console.log(e.latlng);
		}

		//var bus1 = L.marker(center).addTo(map);//.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

		var busses = MVC.List();
		var busStops = MVC.List();

		$(function() {
			$('#map').hide();

			init(function(result) {
				router = L.Routing.osrm()


				if(result) {
					$('body').removeClass('background-image');
					loadBusStops(function() {
						//$('#nodata').hide();
						$('#menu').show();
						$('#map').show();
						update();


						setTimeout(function() {
							var busColor = Store.get("busColor");
							var showBusStops = Boolean(Store.get("showBusStops"));
							// Update UI with bus color
							if(busColor !== null) {
								changeBusLine(busColor);
								$('#selectBusLine').val(busColor);
							}
							if(showBusStops !== null) {
								toggleBusStops(showBusStops, busColor);
								$('#showBusStops').prop('checked', showBusStops);
							}
						}, 1000);
					});
				}
				else {
					$('#nodata').show();
					//$('#map').show();
				}
			});

			$('#selectBusLine').change(function() {
				console.log("#selectBusLine changed");
				var busColor = this.value;
				changeBusLine(busColor);
				Store.save("busColor", busColor);
				console.log(Store.get("busColor"));
				toggleBusStops($('#showBusStops').prop('checked'), $('#selectBusLine option:selected').val());
			});

			$('#showBusStops').click(function() {
				toggleBusStops($(this).prop('checked'), $('#selectBusLine option:selected').val());
			});

			$('#findMe').click(function() {
				findMe();
			});




		    /*map.on('click', function(e) {
			    waypoints.push({latLng: e.latlng});
			    if (waypoints.length >= 2) {
			        router.route(waypoints, function(err, routes) {
			            if (line) {
			                map.removeLayer(line);
			            }

			            if (err) {
			                alert(err);
			            } else {
			                line = L.Routing.line(routes[0]).addTo(map);
			            }
			        });
			    }
			});*/

			/*L.Routing.osrm({
			    waypoints: [
			        L.latLng(62.01574938688206, -6.787834167480469),
			        L.latLng(62.013030754675505, -6.78455114364624)
			    ]
			}).addTo(map);*/
		});

		function changeBusLine(busColor) {
			$.each(busses, function(k,v) {
				if(busColor === '-1') {
					v['canDrawUI'] = true;
				}
				else {
					v['canDrawUI'] = v['lineColor'] === busColor;
				}
			});
		}

		function findMe() {
			map.locate({
				setView : true,
				maxZoom : 17
			});
		}

		function toggleBusStops(isChecked, selectedColor) {
			var opacity = isChecked === true ? 1 : 0;
			$.each(busStops, function(k,v) {
				var busColor = v['color'];
				if(selectedColor === busColor || selectedColor === '-1') {
					v['marker'].setOpacity(opacity);
				}
				else {
					v['marker'].setOpacity(0);
				}
			});

			Store.save("showBusStops", isChecked);
		}

		function loadBusStops(callbackSuccess) {
			getStationDataAsArray(function(data) {
				$.each(data, function(k,station) {

					$.each(station['info'], function(k,v) {
						$.each(v, function(k,busStop) {
							var busStopLineId = busStop['lineId'];
							if(busStopLineId !== undefined) {
								//console.log(busStopLineId);
								var busNoAndColor = lineIdToBusNoAndColor(busStopLineId);
								if(busNoAndColor !== null) {
									busStops.Add(new BusStop(busStop, station, busNoAndColor));
								}
							}
						});
					});
				});
			});
			callbackSuccess();
		}

		function lineIdToBusNoAndColor(_lineId) {
			var lineId = parseInt(_lineId);
			var result = null;
			switch(lineId) {
				case 241:
					result = {no: 1, color: 'Red'};
					break;
				case 242:
					result = {no: 2, color: 'Green'};
					break;
				case 243:
					result = {no: 3, color: 'Blue'};
					break;
				case 261:
					result = {no: 4, color: 'Orange'};
					break;
				case 301:
					result = {no: 5, color: 'Violet'};
					break;
			}
			return result;
		}

		function init(callbackSuccess) {
			getBusDataAsArray(function(data) {
				var hasData = data !== undefined;
				if(hasData) {
					$.each(data, function(k,v) {
						var w = window.innerWidth;
						var h = window.innerHeight;
						var popup = L.popup({
										autoPan: true,
										keepInView: true,
										autoPanPadding: L.point(w/2, h/2),
										closeOnClick: false
									});
							popup.setContent(getMarkerPopupContent(v));

			      		var marker = L.marker(getLatLng(v['lat'], v['lng']));
			      			marker
			      				.setIcon(getMapIcon(v))
			      				.addTo(map)
			      				.bindPopup(popup);
			      		var bus = new Bus(v, marker, true);
						busses.Add(bus);
						//console.log(bus);
				   	});
				   	//console.log(busses.Size());
				}
				callbackSuccess(hasData);
			});
		}

		function update() {
			setInterval(function() {
				getBusDataAsArray(function(data) {
					var hasData = data !== undefined;
					if(hasData) {
						$.each(data, function(k,bus) {
							//console.log(busses[k]['marker']);
							// TODO: Change zero (0)
							//console.log(busses[k]['marker'].getLatLng());
							var icon = getMapIcon(bus);
							var marker = busses[k]['marker'];
							if(busses[k]['canDrawUI']) {
								var latLng = [bus['lat'], bus['lng']];// getLatLng(bus['lat'], bus['lng']);
								// Show the bus
								marker.setOpacity(1);
								marker.setIcon(icon);
								marker.setPopupContent(getMarkerPopupContent(bus));
								marker.setLatLng(latLng);

								//getRouteData(latlng);
								//addCircle(latLng, 10);
								//console.log(latLng);

							}
							else {
								// Hide the bus
								marker.setOpacity(0);
							}
							//console.log(bus);
					   	});
					}
				});
				//console.log(busses.Size());
			}, 1000);
		}

		function addCircle(latlng, size) {
			L.circle(latlng, size).addTo(map);
		}

		function getMapIcon(bus) {
			return L.icon({
				iconUrl: getIcon(bus),
				iconSize: [27, 27]
			});
		}

		function getMarkerPopupContent(bus) {
			return "<b>" + bus['lineName'] + "</b>" +
				"<br />Speed: " + bus['speed'] + " km/h" +
				"<br />ID: " + bus['busId'] + ", Route: " + bus['route'] +
				"<br />Line no.: " + bus['lineNumber'] +
				"<br />Line color: " + bus['lineColor'];
		}

		function getLatLng(lat, lng) {
			return L.latLng(lat, lng);
		}

		function Bus(v, _marker, _canDrawUI) {
			this.speed = v['speed'];
	    	this.info = v['info'];
	    	this.route = v['route'];
	    	this.peopleCount = v['peopleCnt'];
	    	this.lineNumber = v['lineNumber'];
	    	this.lineName = v['lineName'];
	    	this.lineColor = v['lineColor'];
	    	this.lat = v['lat'];
	    	this.lng = v['lng'];
	    	this.inStation = v['inStation'];
	    	this.direction = v['direction'];
	    	this.busNo = v['busNo'];
	    	this.busId = v['busId'];
			this.marker = _marker;
			this.marker.setOpacity(0);
			this.canDrawUI = _canDrawUI;
		}

		function BusStop(_busStop, _station, _busNoAndColor) {
			this.number = _busNoAndColor['no'];
			this.color = _busNoAndColor['color'];
			this.data = _station;
			this.marker = createBusStopMarker(_busStop, _station, _busNoAndColor['color']);
			this.marker.setOpacity(0);
		}

		function createBusStopMarker(_busStop, station, busStopIconColor) {
			var busStopIconRelativePath = 'assets/icons/busStop/';
			var busStopIconNo = '/8.png';

			var popup = L.popup({
							autoPan: false,
							keepInView: false,
							closeOnClick: true
						});
			//console.log(station);
				popup.setContent("<b>" + station['name'] + "</b><br /> Time left: " + _busStop['timeLeft']);

      		var marker = L.marker(getLatLng(station['lat'], station['lng']));
      			marker
      				.setIcon(L.icon({
						iconUrl: busStopIconRelativePath + busStopIconColor + busStopIconNo,
						iconSize: [32, 37]
					}))
      				.addTo(map)
      				.bindPopup(popup);

	      	return marker;
		}

		function getIcon(bus) {
			var direction = parseFloat(bus['direction']);
			var inStation = parseFloat(bus['inStation']);
			var isDelayed = 0;
			var iconUrl = 'assets/icons/bus/';

		  	if (isDelayed === 1) {
		  		return iconUrl + "BusWarning.png";
		  	} else {
		  		iconUrl += bus['lineColor'] + '/';
	  	  		if (inStation === 1){
	  	  			return iconUrl + "Stop.png";
	  	  		}
	  	  		else if (direction > 22.5 && direction < 67.5) {
	  	  			//NE
	  	  			return iconUrl + "NE.png";
	  	  		}
	  	  		else if (direction >= 67.5 && direction <= 112.5) {
	  	  			//E
	  	  			return iconUrl + "E.png";
	  	  		}
	  	  		else if (direction > 112.5 && direction < 157.5) {
	  	  			//SE
	  	  			return iconUrl + "SE.png";
	  	  		}
	  	  		else if (direction >= 157.5 && direction <= 202.5) {
	  	  			//S
	  	  			return iconUrl + "S.png";
	  	  		}
	  	  		else if (direction > 202.5 && direction < 247.5) {
	  	  			//SV
	  	  			return iconUrl + "SV.png";
	  	  		}
	  	  		else if (direction >= 247.5 && direction <= 292.5) {
	  	  			//V
	  	  			return iconUrl + "V.png";
	  	  		}
	  	  		else if (direction > 292.5 && direction < 337.5) {
	  	  			//NV
	  	  			return iconUrl + "NV.png";
	  	  		}
	  	  		else {
	  	  			//N
	  	  			return iconUrl + "N.png";
	  	  		}
	  		}
		}

		function getBusDataAsArray(callback) {
			getBusDataAsJson(function(json) {
				callback(json['bus']);
			});
		}

		function getStationDataAsArray(callback) {
			getStationDataAsJson(function(json) {
				callback(json['station']);
			});
		}

		function getBusDataAsJson(callback) {
			getWSData('http://168.63.68.113/cityroute2/proxy.php', 'buses', 'xml', function(xml) {
				// Parse XML to JSON
			    callback($.xml2json(xml));
			});
		}

		function getStationDataAsJson(callback) {
			//getWSData('http://localhost/dev/cityroute2/proxy.php', 'stations', function(xml) {
			//getWSData('http://kt-husid-webapp.cloudapp.net/cityroute2/proxy.php', 'stations', function(xml) {
			getWSData('assets/data/stations.xml', 'stations', 'xml', function(xml) {
				// Parse XML to JSON
			    callback($.xml2json(xml));
			});
		}

		// Method used to retreive data from REST service, if CORS is not enabled, it
		// will fail...
		function getWSData(url, query, _dataType, callback) {
			/*$.ajax({
			  url: url,
			  dataType: 'xml'
			}).success(function(data) {
				//var json = $.xml2json($.parseXML(data));
			    //alert(json);
			});*/
		  $.ajax({
		    type: 'GET',
		    cache: false,
		    crossDomain: true,
		    dataType: _dataType,
		    data: {'q': query},
		    url: url,
		    success: function(xml) {
		      //console.log(xml);
		      callback(xml);
		    },
		    error: function(xhr, status, errorThrown) {
		      //alert(errorThrown+'\n'+status+'\n'+xhr.statusText);
		    }
		  });
		}
    </script>
    <script src="assets/js/store.js"></script>
    <link rel="stylesheet" href="assets/css/leaflet-routing-machine.css" />
	<script src="assets/js/leaflet-routing-machine.js"></script>
</body>
</html>